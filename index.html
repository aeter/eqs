<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Earthquakes</title>
    <link rel="stylesheet" type="text/css" href="vendor/nouislider-11.1.0/nouislider.min.css">
    <link rel="stylesheet" type="text/css" href="index.css">
    <script type="text/javascript" src="vendor/jquery-3.1.1/jquery.min.js" charset="utf-8"></script>
    <script type="text/javascript" src="vendor/raphael-2.2.7/raphael.min.js" charset="utf-8"></script>
    <script type="text/javascript" src="vendor/jquery-mapael-2.2.0/jquery.mapael.min.js" charset="utf-8"></script>
    <script type="text/javascript" src="vendor/jquery-mapael-2.2.0/world_countries.js" charset="utf-8"></script>
    <script type="text/javascript" src="vendor/jquery-mousewheel-3.1.13/jquery.mousewheel.min.js" charset="utf-8"></script>
    <script type="text/javascript" src="vendor/nouislider-11.1.0/nouislider.min.js" charset="utf-8"></script>
    <script type="text/javascript" src="vendor/alasql-0.4.9/alasql.min.js" charset="utf-8"></script>
    <script type="text/javascript">
$(document).ready(function () {
    var DAMAGE_DESCRIPTIONS = {
        "": "NONE",
        "1": "LIMITED (<$1m (1990 USD))", 
        "2": "MODERATE ($1-5m (1990 USD))",
        "3": "SEVERE ($5-524m (1990 USD))",
        "4": "EXTREME (>525m (1990 USD))"
    }
    alasql('CREATE TABLE quakes; SELECT * INTO quakes from TSV("data/significant_quakes.tsv")');
    alasql.fn.to_date = function(x) { return new Date(x); } // for comparing dates

    var maparea = $(".mapcontainer");
    maparea.mapael({
        map: {
            name: "world_countries",
            zoom: {
                enabled: true,
                maxLevel: 50
            },
            defaultArea: {
                tooltip: {
                    content: function(e) { return $(e.node).attr("data-id"); }
                },
                eventHandlers: {
                    click: function (e, id) {
                        maparea.trigger('zoom', {
                            area: id,
                            areaMargin: 10
                        });
                    }
                }
            }
        }
    });
    noUiSlider.create($('#year_slider').get(0), {
        start: [-10, 10],
        step: 1,
        connect: true,
        tooltips: true,
        range: {
            'min': -2150,
            '50%': [1860, 1],
            'max': 2018
        },
        pips: {
            mode: 'values',
            values: [-2150, -1500, -1000, -500, 0, 500, 
                     1000, 1500, 1850, 1880, 1900, 1920, 1940,
                     1960, 1980, 2000, 2018],
            density: 1000
        }
    });

    function update_damage_values(value, type) {
        value = value == 0 ? "" : value;
        return DAMAGE_DESCRIPTIONS[value];
    }
    noUiSlider.create($('#damage_slider').get(0), {
        start: [1, 4],
        step: 1,
        connect: true,
        range: {
            min: 0,
            max: 4,
        },
        pips: {
            mode: 'steps',
            format: {to: update_damage_values},
        }
    });

    damage_slider.noUiSlider.on('end', recalculate_quakes);
    year_slider.noUiSlider.on('end', recalculate_quakes);

    function quake_info(quake) {
        return "Year: " + quake['YEAR'] 
                + "<br>" 
                + "Location: " + quake['LOCATION_NAME']
                + "<br>"
                + "Damage desc.: " + DAMAGE_DESCRIPTIONS[quake['DAMAGE_DESCRIPTION']];
    }

    function recalculate_quakes() {
        var years = year_slider.noUiSlider.get();
        var damage_descriptions = damage_slider.noUiSlider.get(); // TODO -generate 
        var query = 'select * from quakes where' 
                    + ' YEAR >= __start_year__ and YEAR <= __end_year__ '
                    + ' AND DAMAGE_DESCRIPTION IN (__damage_descriptions__) ';
        var quakes = alasql(query
                    .replace('__start_year__', years[0])
                    .replace('__end_year__', years[1])
                    .replace('__damage_descriptions__', "'', 1, 2, 3, 4"));

        var new_plots = {};
        for (i = 0; i < quakes.length; i++) {
          quakes[i]['latitude'] = quakes[i]['LATITUDE'];
          quakes[i]['longitude'] = quakes[i]['LONGITUDE'];
          quakes[i]['tooltip'] = {content: quake_info(quakes[i])};
          quakes[i]['size'] = 5;
          new_plots[quakes[i]['I_D']] = quakes[i];
        }

        $(".mapcontainer").trigger('update', [{
            mapOptions: {'areas': {}, 'plots': {}}, 
            newPlots: new_plots,
            deletePlotKeys: Object.keys(maparea.data('mapael').plots),
            animDuration: 0 
        }]);
    };
});
    </script>
  </head>
  <body>
    <a href="https://github.com/aeter/eqs/">
        <img style="position: absolute; top: 0; right: 0; border: 0;"
          src="vendor/github/forkme_right_darkblue.png"
          alt="Fork me on GitHub">
    </a>
    <div class="container">
      <h1 title="Information on destructive earthquakes from 2150 B.C. to the
          present that meet at least one of the following criteria: Moderate
          damage (approximately $1 million or more), 10 or more deaths,
          Magnitude 7.5 or greater, Modified Mercalli Intensity X or greater, or
          the earthquake generated a tsunami.">Significant earthquakes</h1>
      <div class="mapcontainer mapael">
        <div class="map">
        </div>
      <div>
    </div>
    <hr>
    Year <div id="year_slider">
    </div>
    <br>
    <br>
    <br>
    Damage
    <div id="damage_slider">
    </div>
    <br>
    <br>
    <br>
    <br>
    <a href="http://dx.doi.org/10.7289/V5TD9V7K">Data source</a>
  </body>
</html>
